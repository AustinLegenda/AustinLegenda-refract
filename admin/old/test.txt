<?php

// Create connection
$conn = new mysqli("hostname", "username", "password", "database);

// Check if the connection was successful
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

// Try method for catching errors
try {
    // Perform the API request using cURL
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, "https://www.ndbc.noaa.gov/data/realtime2/41112.spec");
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    $output = curl_exec($ch);
    curl_close($ch);
} catch (Exception $e) {
    error_log($e->getMessage());
}

// Print the contents of the API response to check if it is being retrieved correctly
echo $output;

// parseData function to insert data into the database
function parseData($data) {
    $lines = explode("\n", $data);
    foreach ($lines as $line) {
        if (strlen($line) == 0) {
            continue;
        }
        $values = explode(" ", $line);
        $year = intval($values[0]);
        $month = intval($values[2]);
        $day = intval($values[4]);
        $hour = intval($values[6]);
        $minute = intval($values[8]);
        $wvht = (strlen($values[10]) > 0) ? floatval($values[10]) : null;
        $swh = (strlen($values[12]) > 0) ? floatval($values[12]) : null;
        $swp = (strlen($values[14]) > 0) ? floatval($values[14]) : null;
        $wwh = (strlen($values[16]) > 0) ? floatval($values[16]) : null;
        $wwp = (strlen($values[18]) > 0) ? floatval($values[18]) : null;
        $swd = (strlen($values[20]) > 0) ? floatval($values[20]) : null;
        $wwd = (strlen($values[22]) > 0) ? floatval($values[22]) : null;
        $steepness = (strlen($values[24]) > 0) ? floatval($values[24]) : null;
        $apd = (strlen($values[26]) > 0) ? floatval($values[26]) : null;
        $mwd = (strlen($values[28]) > 0) ? floatval($values[28]) : null;
        
        // Prepare and bind the SQL statement
        $stmt = $GLOBALS['conn']->prepare("INSERT INTO buoy_data (year, month, day, hour, minute, wvht, swh, swp, wwh, wwp, swd, wwd, steepness, apd, mwd)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");
        $stmt->bind_param("iiiiidddddddddd", $year, $month, $day, $hour, $minute, $wvht, $swh, $swp, $wwh, $wwp, $swd, $wwd, $steepness, $apd, $mwd);
        
        // Execute the statement
        if ($stmt->execute()) {
            echo "Data inserted successfully\n";
        } else {
            echo "Error inserting data: " . $stmt->error . "\n"; 
        }
    }
}
